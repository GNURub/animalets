---
import BookingWizard from '../../components/BookingWizard';
import AppLayout from '../../layouts/AppLayout.astro';

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect('/signin');
}

// Obtener mascotas del usuario para el selector
const { data: pets } = await Astro.locals.supabase
  .from('pets')
  .select('*')
  .eq('owner_id', user.id)
  .order('name', { ascending: true });

// Obtener servicios activos
const { data: services } = await Astro.locals.supabase
  .from('services')
  .select('*')
  .eq('is_active', true)
  .order('name', { ascending: true });
---

<AppLayout title='Reservar Cita'>
  <div class='mx-auto max-w-4xl'>
    <div class='mb-8'>
      <h1 class='mb-2 text-3xl font-bold text-gray-900'>Reservar Cita</h1>
      <p class='text-gray-600'>
        Selecciona el servicio, mascota y horario para tu cita
      </p>
    </div>

    {
      pets && pets.length === 0 ? (
        <div class='card py-12 text-center'>
          <div class='mb-4 text-6xl'>üêæ</div>
          <h3 class='mb-2 text-xl font-semibold text-gray-900'>
            Primero debes registrar una mascota
          </h3>
          <p class='mb-6 text-gray-600'>
            Para poder reservar una cita, necesitas tener al menos una mascota
            registrada
          </p>
          <a href='/app/mascotas' class='btn btn-primary inline-block'>
            Ir a Mis Mascotas
          </a>
        </div>
      ) : (
        <BookingWizard
          client:load
          pets={pets || []}
          services={services || []}
          userId={user.id}
        />
      )
    }
  </div>
</AppLayout>
